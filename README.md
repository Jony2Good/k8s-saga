# Задание
*Цель*: Реализовать сервис заказа, биллинга, нотификации. Настроить их взаимодействие с помощью брокера сообщений

### Задача

**Реализовать сценарий "Изменение и просмотр данных в профиле клиента".**
 - При регистрации пользователя создается аккаунт в сервисе биллинга. В сервисе биллинга должна быть возможность положить деньги на аккаунт и снять деньги.
 - Сервис нотификаций позволяет отправить сообщение на email. И позволяет получить список сообщений по методу API.
 - Пользователь может создать заказ. У заказа есть параметр - цена заказа.
 - Заказ происходит в 2 этапа: 1) сначала снимаем деньги с пользователя с помощью сервиса биллинга 2) отсылаем пользователю сообщение на почту с результатами оформления заказа.
 - Спроектировать взаимодействие сервисов при создании заказов. 

#### На выходе должны быть предоставлена

1. Описание архитектурного решения и схема взаимодействия сервисов (в виде картинки).
2. Команда установки приложения.
3. Спецификация по методам api.

##### Как сделать запросы к приложению с помощью POSTMAN?

  - импортируем файл openapi.yaml в POSTMAN (выбираем чек-бокс Postman collection). 
  - название коллекции "Тестовый сервис"

------------

### Результат
1. [Схема-картинка с работой сервисов][1]
2. [Описание работы сервисов ][3]
3. Команда установки состоит из двух этапов. Ниже по тексту
4. [Спецификация][2]
5. [Описание реализации SAGA][5]
   
------------

### Инструкция по запуску приложения

**Клонирум проект в локальный репозиторий**

 ```
 git clone https://github.com/Jony2Good/k8s-restful.git

```
**Стартуем minikube**

```
minikube start
```

### Первый этап - устанавливаем namespace, запускаем API Gateway

**Инициализируем манифесты**

```
kubectl apply -f k8s/first/api-gateway
```

#### Подготовка к установке остальных сервисов

1. Установка ingress-nginx

**Получаем нужный репозиторий из helm**

```
helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx
```

**Устанавливаем ingress-controller в namespase k8s-basics и конфигурируем Prometheus**

```
helm install ingress-nginx ingress-nginx/ingress-nginx --namespace k8s-basics
```

**Проверяем services**

```
kubectl get svc -n k8s-basics
```

Должна появится таблица. Нас интересует только ingress-nginx-controller. У него должен быть *Type:LoadBalanser* и *External-IP:pending*

| NAME                    | TYPE         | CLUSTER-IP     | EXTERNAL-IP    | PORT(S)                    | AGE |
| ----------------------- | ------------ | -------------- | -------------- | -------------------------- | --- |
| ngress-nginx-controller | LoadBalancer | 10.104.118.219 |  pending  | 80:31047/TCP,443:31617/TCP | 95m |


2. Проброс ingress-nginx наружу

**Нам необходимо, чтобы домен arch.homework открывался без порта и по специальному url. Для этого мы должны прописать команду:**

```
minikube tunnel
```

Далее снова смотрим в таблицу на значение в колонке **EXTERNAL-IP** (вместо pending должно появится значение, к примеру, 10.107.105.245) в ней должен прописаться внешний IP-адрес.

```
kubectl get svc -n k8s-basics
```

Копируем данный внешний адрес и прописываем в файле hosts машины правило маршрутизации, где развернут кластер:

```
10.107.105.245 arch.homework
```
Справка: для ОС windows прописываем в файле и сохраняем:
```
C:\Windows\System32\drivers\etc\hosts
```

#### Второй этап - поднимаем сервисы

**Инициализируем манифесты**

```
kubectl apply -f k8s/second/auth-service/
```

```
kubectl apply -f k8s/second/billing-service/
```

```
kubectl apply -f k8s/second/notification-service/
```

```
kubectl apply -f k8s/second/order-service/
```

```
kubectl apply -f k8s/second/stock-service/
```

```
kubectl apply -f k8s/second/delivery-service/
```

После успешной инициализации подов далее работаем с postman (спецификация в проекте). Не забываем, что сначала необходимо:

1. Заререгестрироваться auth/vi/register
2. Залогиниться auth/vi/register. В ответе придет JWT, который нужно использовать в дальнейших запросах
3. Пополнить счет billing/v1/me (метод PUT)
4. Создать заказ orders/v1/orders (метод POST). Запоминаем id заказа
5. Оплатить заказ orders/v1/payments. Вставить id заказа в запрос

[1]: https://github.com/Jony2Good/k8s-restful/blob/main/restful-schema.png "Схема-картинка"
[2]: https://github.com/Jony2Good/k8s-restful/blob/main/openapi.yaml "Спецификация"
[3]: https://github.com/Jony2Good/k8s-restful/blob/main/restful-description.md "Описание работы сервисов"
[5]: https://github.com/Jony2Good/k8s-restful/blob/main/SAGA-DESCR.md  "Реализация паттерна SAGA"